<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Текстильное ателье</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .blur-edges::before, .blur-edges::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3rem;
      z-index: 10;
    }
    .blur-edges::before { left: 0; background: linear-gradient(to right, #f8f4f2, transparent); }
    .blur-edges::after { right: 0; background: linear-gradient(to left, #f8f4f2, transparent); }
    html { -webkit-text-size-adjust: 100%; }
    
    /* Стили для поднятия поиска при фокусе */
    .search-container {
      transition: transform 0.3s ease;
    }
    .search-focused {
      transform: translateY(-20px);
    }
    
    /* Блокировка скролла */
    .no-scroll {
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    /* Подсветка найденной карточки */
    .highlight-card {
      animation: highlight 3s ease-in-out;
      border-color: #f59e0b !important;
      background: rgba(245, 158, 11, 0.15) !important;
    }
    
    @keyframes highlight {
      0%, 100% { 
        border-color: #e1dedb;
        background: rgba(255, 255, 255, 0.1);
      }
      25%, 75% { 
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.15);
      }
    }
    
    /* Добавляем отступ снизу для контента */
    .content-container {
      padding-bottom: 140px;
    }
    
    /* Улучшенные стили для поиска */
    .search-bar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-[#f8f4f2] text-[#383533] font-['Rubik'] min-h-screen flex flex-col">
  <div class="container mx-auto px-4 py-6 flex-1 content-container">
    <!-- Категории -->
    <div class="relative mb-8 blur-edges z-10">
      <div id="categoryContainer" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide py-2">
        <div id="categories" class="flex space-x-3 px-4"></div>
      </div>
    </div>
    <!-- Список услуг -->
    <div id="services" class="grid gap-3"></div>
    
    <!-- Поиск -->
    <div class="fixed bottom-4 left-4 right-4 z-20 search-container" id="searchContainer">
      <div class="relative flex items-center bg-transparent backdrop-blur-[3px] p-3 shadow-sm border border-[#e1dedb]/50" style="border-radius: 10px;">
        <svg class="w-5 h-5 text-[#383533] ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input id="searchInput" type="text" placeholder="Поиск..." class="bg-transparent outline-none w-full text-sm text-[#383533] placeholder-[#383533]/70 pl-2 pr-3">
        <button id="clearSearch" class="hidden ml-2 text-[#383533]/50 hover:text-[#383533] transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Модальное окно -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-30">
      <div class="bg-[#f8f4f2] rounded-xl max-w-md w-full max-h-[80vh] shadow-2xl flex flex-col">
        <!-- Заголовок -->
        <div class="p-5 pb-3">
          <h2 id="modalTitle" class="text-lg font-semibold"></h2>
        </div>
        <!-- Содержимое с прокруткой -->
        <div class="flex-1 overflow-y-auto px-5">
          <div id="modalContent" class="text-sm"></div>
        </div>
        <!-- Зафиксированная кнопка внизу -->
        <div class="border-t border-[#e1dedb]/30 p-4">
          <button id="closeModal" class="w-full px-4 py-2 bg-[#383533] text-white rounded-lg text-sm hover:bg-[#383533]/90 transition-colors">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    fetch('./data.json')
      .then(response => response.json())
      .then(data => {
        const categories = data.categories;
        const categoryContainer = document.getElementById('categories');
        const servicesContainer = document.getElementById('services');
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const searchContainer = document.getElementById('searchContainer');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');

        let activeCategory = categories[0].name;
        let isSearching = false;

        function renderCategories() {
          categoryContainer.innerHTML = categories
            .map(cat => `
              <button class="text-base font-medium snap-center px-3 py-1.5 rounded-md whitespace-nowrap transition-all ${cat.name === activeCategory ? 'bg-[#fbede0] text-[#383533]' : 'text-[#383533]/70 hover:text-[#383533]'}" data-category="${cat.name}">
                ${cat.name}
              </button>
            `)
            .join('');
        }

        function renderServices(categoryName) {
          const category = categories.find(cat => cat.name === categoryName);
          
          if (!category || !category.services || category.services.length === 0) {
            servicesContainer.innerHTML = '<p class="text-sm text-center text-[#383533]/60 py-8">В этой категории пока нет услуг</p>';
            return;
          }

          servicesContainer.innerHTML = category.services
            .map(service => {
              return `
                <div class="service-card bg-white/10 backdrop-blur-[6px] rounded-lg p-3 flex items-start space-x-3 cursor-pointer border border-[#e1dedb]/50 transition-all hover:bg-white/20" data-service="${service.title}">
                  <svg class="w-6 h-6 text-[#383533] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${service.icon}</svg>
                  <div>
                    <h3 class="font-semibold text-sm">${service.title}</h3>
                    <p class="text-xs text-[#383533]/80">${service.description}</p>
                  </div>
                </div>
              `;
            })
            .join('');
        }

        function renderModal(service) {
          modalTitle.textContent = service.title;
          modalContent.innerHTML = service.details
            ? Object.entries(service.details)
                .map(([section, items]) => `
                  <div class="mb-4">
                    <h4 class="font-medium text-base mb-2 text-[#383533]">${section}</h4>
                    <ul class="space-y-1">
                      ${Object.entries(items)
                        .map(([key, value]) => `<li class="text-sm"><span class="font-medium">${key}:</span> <span class="text-[#383533]/80">${value}</span></li>`)
                        .join('')}
                    </ul>
                  </div>
                `)
                .join('')
            : '<p class="text-sm text-[#383533]/60">Нет подробной информации</p>';
          
          modal.classList.remove('hidden');
          document.body.classList.add('no-scroll');
        }

        function closeModalHandler() {
          modal.classList.add('hidden');
          document.body.classList.remove('no-scroll');
        }

        function searchInDetails(service, query) {
          if (!service.details) return false;
          
          const searchText = query.toLowerCase();
          
          return Object.entries(service.details).some(([section, items]) => {
            // Поиск в названии секции
            if (section.toLowerCase().includes(searchText)) return true;
            
            // Поиск в ключах и значениях
            return Object.entries(items).some(([key, value]) => 
              key.toLowerCase().includes(searchText) || 
              value.toLowerCase().includes(searchText)
            );
          });
        }

        function filterServices(query) {
          if (!query.trim()) {
            isSearching = false;
            renderServices(activeCategory);
            clearSearch.classList.add('hidden');
            return;
          }

          clearSearch.classList.remove('hidden');
          isSearching = true;
          query = query.toLowerCase();

          // Собираем все релевантные услуги из всех категорий
          let allRelevantServices = [];

          for (const cat of categories) {
            if (!cat.services) continue;
            
            for (const service of cat.services) {
              const matchesTitle = service.title.toLowerCase().includes(query);
              const matchesDescription = service.description.toLowerCase().includes(query);
              const matchesDetails = searchInDetails(service, query);

              if (matchesTitle || matchesDescription || matchesDetails) {
                allRelevantServices.push({
                  service: service,
                  category: cat,
                  relevanceScore: (matchesTitle ? 3 : 0) + (matchesDescription ? 2 : 0) + (matchesDetails ? 1 : 0)
                });
              }
            }
          }

          if (allRelevantServices.length > 0) {
            // Сортируем по релевантности (выше балл = выше в списке)
            allRelevantServices.sort((a, b) => b.relevanceScore - a.relevanceScore);
            
            // Находим самую релевантную категорию
            const topResult = allRelevantServices[0];
            
            // Переключаем категорию если нужно
            if (activeCategory !== topResult.category.name) {
              activeCategory = topResult.category.name;
              renderCategories();
            }
            
            // Показываем отсортированные результаты
            renderSortedSearchResults(allRelevantServices, query);
            
            // Прокручиваем вверх для просмотра результатов
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            // При отсутствии результатов остаемся в поиске, но показываем сообщение
            servicesContainer.innerHTML = '<div class="text-center py-8"><p class="text-sm text-[#383533]/60 mb-2">Ничего не найдено</p><p class="text-xs text-[#383533]/40">Попробуйте изменить запрос</p></div>';
            // Не сбрасываем фокус и состояние поиска
          }
        }

        function renderSortedSearchResults(relevantServices, query) {
          // Показываем только услуги из текущей активной категории, но отсортированные
          const currentCategoryServices = relevantServices.filter(item => item.category.name === activeCategory);
          
          if (currentCategoryServices.length === 0) {
            servicesContainer.innerHTML = '<p class="text-sm text-center text-[#383533]/60 py-8">Ничего не найдено в текущей категории</p>';
            return;
          }

          servicesContainer.innerHTML = currentCategoryServices
            .map((item, index) => {
              const service = item.service;
              const isTopResult = index === 0; // Подсвечиваем самый релевантный
              return `
                <div class="service-card bg-white/10 backdrop-blur-[6px] rounded-lg p-3 flex items-start space-x-3 cursor-pointer border border-[#e1dedb]/50 transition-all hover:bg-white/20 ${isTopResult ? 'highlight-card' : ''}" data-service="${service.title}">
                  <svg class="w-6 h-6 text-[#383533] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${service.icon}</svg>
                  <div>
                    <h3 class="font-semibold text-sm">${service.title}</h3>
                    <p class="text-xs text-[#383533]/80">${service.description}</p>
                  </div>
                </div>
              `;
            })
            .join('');

          // Убираем подсветку через время
          setTimeout(() => {
            const highlightedCard = document.querySelector('.highlight-card');
            if (highlightedCard) {
              highlightedCard.classList.remove('highlight-card');
            }
          }, 3000);
        }

        function clearSearchHandler() {
          searchInput.value = '';
          clearSearch.classList.add('hidden');
          isSearching = false;
          renderServices(activeCategory);
          closeModalHandler();
        }

        // Обработка фокуса на поле поиска
        searchInput.addEventListener('focus', () => {
          searchContainer.classList.add('search-focused');
        });

        searchInput.addEventListener('blur', () => {
          // Задержка для предотвращения мигания при переключении на другой элемент
          setTimeout(() => {
            if (document.activeElement !== searchInput && document.activeElement !== clearSearch) {
              searchContainer.classList.remove('search-focused');
            }
          }, 150);
        });

        // Инициализация
        renderCategories();
        renderServices(activeCategory);

        // Обработчики событий
        categoryContainer.addEventListener('click', e => {
          const target = e.target.closest('[data-category]');
          if (target) {
            activeCategory = target.getAttribute('data-category');
            renderCategories();
            renderServices(activeCategory);
            // Полный сброс поиска
            searchInput.value = '';
            clearSearch.classList.add('hidden');
            closeModalHandler();
            isSearching = false;
            // Убираем фокус с поиска чтобы избежать проблем
            searchContainer.classList.remove('search-focused');
          }
        });

        servicesContainer.addEventListener('click', e => {
          const target = e.target.closest('[data-service]');
          if (target) {
            const serviceTitle = target.getAttribute('data-service');
            const service = categories
              .find(cat => cat.name === activeCategory)
              .services.find(s => s.title === serviceTitle);
            if (service) {
              renderModal(service);
            }
          }
        });

        closeModal.addEventListener('click', closeModalHandler);

        // Закрытие модалки по клику на фон
        modal.addEventListener('click', e => {
          if (e.target === modal) {
            closeModalHandler();
          }
        });

        searchInput.addEventListener('input', e => {
          // Сохраняем состояние фокуса
          const wasFocused = document.activeElement === searchInput;
          filterServices(e.target.value);
          // Восстанавливаем фокус если он был
          if (wasFocused) {
            setTimeout(() => searchInput.focus(), 10);
          }
        });

        clearSearch.addEventListener('click', e => {
          e.preventDefault();
          clearSearchHandler();
          // Возвращаем фокус на поле поиска
          searchInput.focus();
        });

        // Закрытие модалки по Escape
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') {
            closeModalHandler();
          }
        });
      })
      .catch(error => console.error('Ошибка загрузки data.json:', error));
  </script>
</body>
</html>
